name: vcards
graphs:
  start:
    - type: ReadChunkFile
      inputFile: "/home/schimpf/droplet/extract-vcards/bench/text.txt"
      output: "output-chunk"
      streamTarget: process-chunk

  process-chunk:
    - type: ToLowerCase
      string: "{output-chunk}"
      output: output-lower

    - type: Regex
      regex: "(begin:vcard.*?end:vcard)"
      content: "{output-lower}"
      output: output
      groups: { content: 1 }
      streamTarget: vcard-match

  vcard-match:
    - type: Echo
      log: Found potential vcard
      put: vcard
      value: "{{output}@content}"
    #    useful for debugging purposes
#
#    - type: WriteLineToFile
#      output: "last.match"
#      overwrite: true
#      line: "{vcard}"

    - type: Regex
      regex: "name:(.*?)\nfn:(.*?)\nn:(.*?)\n"
      content: "{vcard}"
      streamTarget: vcard-extract
      output: "v"
      groups:
        uid: 1
        fn: 2
        rev: 3

  vcard-extract:
    - type: WriteLineToFile
      log: "Found vcard"
      output: "vcards/{{v}@uid}/{{v}@fn}/{{v}@rev}.vcf"
      overwrite: true
      line: "{vcard}"


